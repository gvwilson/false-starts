<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Nitinat</title>
    <link rel="stylesheet" href="theme/nitinat.css">
    <link rel="stylesheet" href="theme/tango.css">
  </head>
  <body>
    <div class="row">
      <div class="column smaller">
        <h2><a href="index.html">Nitinat</a></h2>
        <p>
          A model data analysis project in Python
        </p>
	<ol type="1">
  
  <li>
    <a href="starting.html">
      
        Starting
      
    </a>
  </li>
  
  <li>
    <a href="project.html">
      
        Setting Up a Python Project
      
    </a>
  </li>
  
  <li>
    <a href="dataset.html">
      
        Handling Data
      
    </a>
  </li>
  
  <li>
    <a href="reproducible.html">
      
        Making Tasks Reproducible
      
    </a>
  </li>
  
  <li>
    <a href="results.html">
      
        Producing Results
      
    </a>
  </li>
  
  <li>
    <a href="quality.html">
      
        Checking Code Quality
      
    </a>
  </li>
  
  <li>
    <a href="setback-01.html">
      
        The First Setback
      
    </a>
  </li>
  
  <li>
    <a href="configuration.html">
      
        Consistent Configuration
      
    </a>
  </li>
  
  <li>
    <a href="testing.html">
      <strong>
        Improving Testing
      </strong>
    </a>
  </li>
  
  <li>
    <a href="logging.html">
      
        Logging
      
    </a>
  </li>
  
  <li>
    <a href="technical-debt-01.html">
      
        Technical Debt
      
    </a>
  </li>
  
  <li>
    <a href="parameters.html">
      
        Handling Model Parameters
      
    </a>
  </li>
  
  <li>
    <a href="pipeline-01.html">
      
        Creating a Pipeline
      
    </a>
  </li>
  
  <li>
    <a href="technical-debt-02.html">
      
        Technical Debt Revisited
      
    </a>
  </li>
  
  <li>
    <a href="pipeline-02.html">
      
        Pipeline Revisited
      
    </a>
  </li>
  
  <li>
    <a href="website-01.html">
      
        Creating a Website
      
    </a>
  </li>
  
  <li>
    <a href="pipeline-03.html">
      
        A Pipeline with Provenance
      
    </a>
  </li>
  
  <li>
    <a href="website-02.html">
      
        Improving the Website
      
    </a>
  </li>
  
  <li>
    <a href="documentation.html">
      
        Documenting Code
      
    </a>
  </li>
  
  <li>
    <a href="packaging.html">
      
        Creating a Package
      
    </a>
  </li>
  
  <li>
    <a href="ci.html">
      
        Continuous Integration
      
    </a>
  </li>
  
  <li>
    <a href="indexing.html">
      
        Indexing Datasets
      
    </a>
  </li>
  
  <li>
    <a href="dependencies.html">
      
        Handling Task Dependencies
      
    </a>
  </li>
  
  <li>
    <a href="layered.html">
      
        Layered Configuration
      
    </a>
  </li>
  
  <li>
    <a href="database.html">
      
        Accessing a Database
      
    </a>
  </li>
  
</ol>
<ol type="A">
  
  <li>
    <a href="data.html">
      
        Parameter Sets
      
    </a>
  </li>
  
  <li>
    <a href="license.html">
      
        License
      
    </a>
  </li>
  
  <li>
    <a href="links.html">
      
        Links
      
    </a>
  </li>
  
  <li>
    <a href="credits.html">
      
        Credits
      
    </a>
  </li>
  
</ol>

	<ul>
	  <li><a href="nitinat/index.html">Documentation</a></li>
	  <li><a href="https://github.com/gvwilson/nitinat/">Source</a></li>
	</ul>
      </div>
      <div class="column bordered">
        <h1>Improving Testing</h1>
        <ul>
<li>Data cleaning and data reading need to be tested</li>
<li>Test #1: sample actual data and read that to make sure character encoding works<ul>
<li><code>head -n 3 data/canadian-dietary-radionuclides-2000-2020.csv &gt; tests/three-rows.csv</code></li>
<li><code>od -c tests/three-rows.csv</code> shows some non-ASCII characters</li>
</ul>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">nitinat.data</span> <span class="kn">import</span> <span class="n">COLUMNS</span><span class="p">,</span> <span class="n">clean_raw_data</span><span class="p">,</span> <span class="n">read_clean_data</span>

<span class="k">def</span> <span class="nf">test_clean_raw_data_handles_character_encoding</span><span class="p">():</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;three-rows.csv&quot;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">clean_raw_data</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">COLUMNS</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
</code></pre></div>
<ul>
<li>The special variable <code>__file__</code> holds the full path of this file<ul>
<li>Its parent is the directory that contains it</li>
<li>So the complicated <code>Path</code> expression gets <code>three-rows.csv</code> in the current directory</li>
</ul>
</li>
<li>Test #2: temporarily replace <code>pandas.read_csv</code> with something that returns a hand-written dataframe</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">patch</span>

<span class="k">def</span> <span class="nf">test_clean_raw_data_produces_correct_column_names</span><span class="p">(</span><span class="n">test_df</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;nitinat.data.pd.read_csv&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">test_df</span><span class="p">):</span>
        <span class="n">cooked_df</span> <span class="o">=</span> <span class="n">clean_raw_data</span><span class="p">(</span><span class="s2">&quot;something.csv&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">cooked_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">COLUMNS</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">cooked_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</code></pre></div>
<ul>
<li><code>patch</code> takes the dotted path to the specific use of the function or method we want to replace<ul>
<li>And the value we want to return</li>
<li>When <code>clean_raw_data</code> runs, <code>read_csv</code> is intercepted and our dataframe returned</li>
</ul>
</li>
<li>Where does <code>test_df</code> come from?<ul>
<li>We create a fixture: a function that produces something a test can be run on</li>
</ul>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nd">@fixture</span>
<span class="k">def</span> <span class="nf">test_df</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="p">[</span>
            <span class="s2">&quot;apple|2019-01-01|No|Ontario|2019-01-05|0.5|Bq/Kg|carbon&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">),</span>
            <span class="s2">&quot;bread|2019-10-01|Yes|Quebec|2019-10-05|0.05|Bq/Kg|Lead-210&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">[</span>
            <span class="s2">&quot;Food Name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Sample Collection Date&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Human Illness Flag&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Sampling Location Province&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Analysis Completion Date&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Result Value&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Units of measurement&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Analyte Name&quot;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">)</span>
</code></pre></div>
<ul>
<li>When its name appears as a parameter to a test function, <code>pytest</code> calls our function and passes in the result<ul>
<li>It's a bit cumbersome to set up, but we can re-use <code>test_df</code> in other tests</li>
</ul>
</li>
<li>How much of our code have we tested?<ul>
<li>Add a task:</li>
</ul>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nd">@task</span>
<span class="k">def</span> <span class="nf">coverage</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find test coverage.&quot;&quot;&quot;</span>
    <span class="n">c</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;coverage run --branch -m pytest&quot;</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;coverage html --omit=&#39;test*.py&#39;&quot;</span><span class="p">)</span>
</code></pre></div>
<ul>
<li><a href="https://coverage.readthedocs.io/">coverage</a> keeps track of which lines were(n't) executed and which way branches went<ul>
<li>Saves data in <code>.coverage</code> in a custom (binary) format</li>
<li><code>coverage html</code> generates an HTML coverage report in <code>htmlcov/index.html</code></li>
</ul>
</li>
</ul>
<div class="highlight"><pre><span></span><code>Module            statements  missing  excluded  branches  partial  coverage
nitinat/data.py           14        4         0         6        0       60%
nitinat/__init__.py        2        0         0         0        0      100%
Total                     16        4         0         6        0       64%
</code></pre></div>
<ul>
<li>Clicking on <code>nitinat/data.py</code> takes us to a line-by-line report<ul>
<li>We haven't tested the data cleanup function yet</li>
</ul>
</li>
</ul>
      </div>
    </div>
  </body>
</html>
