<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/x-icon" href="../favicon.ico">
    <title>Nitinat</title>
    <link rel="stylesheet" href="../mccole.css">
    <link rel="stylesheet" href="../tango.css">
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { equationNumbers: { autoNumber: "AMS" } }
      })
    </script>
    <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  </head>
  <body>
    <div class="row">
      <div class="column">
        <h2><a href="../">Nitinat</a></h2>
        <p>
          A model data analysis project
        </p>
	<ol type="1">
  
  <li>
    <a href="../starting/">
      
        Starting
      
    </a>
  </li>
  
  <li>
    <a href="../project/">
      
        Setting Up a Python Project
      
    </a>
  </li>
  
  <li>
    <a href="../dataset/">
      <strong>
        Getting a Dataset
      </strong>
    </a>
  </li>
  
  <li>
    <a href="../script/">
      
        Writing Robust Scripts
      
    </a>
  </li>
  
  <li>
    <a href="../unittest/">
      
        Unit Testing
      
    </a>
  </li>
  
  <li>
    <a href="../automation/">
      
        Automation
      
    </a>
  </li>
  
  <li>
    <a href="../caching/">
      
        Caching
      
    </a>
  </li>
  
  <li>
    <a href="../dependencies/">
      
        Dependencies
      
    </a>
  </li>
  
  <li>
    <a href="../pipeline/">
      
        Building a Pipeline
      
    </a>
  </li>
  
  <li>
    <a href="../configuration/">
      
        Configuration
      
    </a>
  </li>
  
  <li>
    <a href="../provenance/">
      
        Provenance
      
    </a>
  </li>
  
  <li>
    <a href="../organizing/">
      
        Organizing a Data Analysis
      
    </a>
  </li>
  
  <li>
    <a href="../documentation/">
      
        Documentation
      
    </a>
  </li>
  
  <li>
    <a href="../logging/">
      
        Logging
      
    </a>
  </li>
  
  <li>
    <a href="../coverage/">
      
        Code Coverage
      
    </a>
  </li>
  
  <li>
    <a href="../packaging/">
      
        Packaging
      
    </a>
  </li>
  
  <li>
    <a href="../website/">
      
        Build a Website
      
    </a>
  </li>
  
  <li>
    <a href="../indexing/">
      
        Indexing
      
    </a>
  </li>
  
  <li>
    <a href="../approximation/">
      
        Approximation
      
    </a>
  </li>
  
  <li>
    <a href="../database/">
      
        Using a Database
      
    </a>
  </li>
  
  <li>
    <a href="../service/">
      
        Creating a Web Service
      
    </a>
  </li>
  
</ol>
<ol type="A">
  
  <li>
    <a href="../license/">
      
        License
      
    </a>
  </li>
  
  <li>
    <a href="../conduct/">
      
        Code of Conduct
      
    </a>
  </li>
  
  <li>
    <a href="../links/">
      
        Links
      
    </a>
  </li>
  
  <li>
    <a href="../credits/">
      
        Credits
      
    </a>
  </li>
  
</ol>

      </div>
      <div class="column bordered">
        <h1>Getting a Dataset</h1>
        <ul>
<li>The steps in most data analysis projects are:<ol>
<li>Find data</li>
<li>Collect it</li>
<li>Tidy it</li>
<li>Do calculations</li>
<li>Report results</li>
</ol>
</li>
<li>To illustrate Step 2, let's find out how many versions of Python packages there are</li>
<li>Data source is the simple <a href="https://pypi.org/">PyPI</a> package index page <a href="https://pypi.org/simple/">https://pypi.org/simple/</a><ul>
<li>Has HTML links to one page per package</li>
</ul>
</li>
<li>Each package's page has links to released versions in various formats<ul>
<li>Over 200K entries</li>
</ul>
</li>
<li>
<p>Some redundancy, e.g., <a class="glossref" href="../gloss/#wheel" markdown="1">wheels</a> and <a class="glossref" href="../gloss/#gzip" markdown="1">gzip'd</a> <a class="glossref" href="../gloss/#tar" markdown="1">tar</a> files</p>
<ul>
<li>We have to decide whether to count these separately or fold them together</li>
<li>Every statistical result is the product of many decisions</li>
<li>Different decisions produce different results</li>
</ul>
</li>
<li>
<p>Use the <a href="https://docs.python-requests.org/"><code>requests</code></a> library to get page</p>
</li>
<li>The HTML is very highly structured (machine-generated),
    so we can extract fields using <a class="glossref" href="../gloss/#regular_expression" markdown="1">regular expressions</a><ul>
<li><a href="https://stackoverflow.com/questions/1732348/regex-match-open-tags-except-xhtml-self-contained-tags/1732454#1732454">This is a sin</a></li>
<li>Look at better ways in <a class="crossref" href="../website/">Chapter 17</a></li>
</ul>
</li>
</ul>
<div class="highlight"><span class="filename">get-release-counts-naive.py</span><pre><span></span><code><span class="kn">import</span> <span class="nn">re</span>

<span class="kn">import</span> <span class="nn">requests</span>

<span class="c1"># Match package URL in main index page.</span>
<span class="n">RE_PACKAGE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;a href=&quot;(.+?)&quot;&gt;&#39;</span><span class="p">)</span>

<span class="c1"># Match release URL in package index page.</span>
<span class="n">RE_RELEASE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;a href=&quot;.+?&quot;&gt;(.+?)&lt;/a&gt;&#39;</span><span class="p">)</span>

<span class="c1"># PyPI domain.</span>
<span class="n">DOMAIN</span> <span class="o">=</span> <span class="s2">&quot;https://pypi.org&quot;</span>


<span class="n">index_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DOMAIN</span><span class="si">}</span><span class="s2">/simple/&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Package,Releases&quot;</span><span class="p">)</span>
<span class="n">all_packages</span> <span class="o">=</span> <span class="n">RE_PACKAGE</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">index_response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="k">for</span> <span class="n">package</span> <span class="ow">in</span> <span class="n">all_packages</span><span class="p">:</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">package</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DOMAIN</span><span class="si">}{</span><span class="n">package</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">package_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">RE_RELEASE</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">package_response</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<ul>
<li>Still not a friendly program<ul>
<li>If several thousand people run this program at the same time it will slow PyPI down</li>
</ul>
</li>
<li>Unlikely in this case,
    but a school could easily wind up being <a class="glossref" href="../gloss/#blacklisting" markdown="1">blacklisted</a>
    if a hundred students are grabbing data at the same time</li>
<li>Popular data sources have to manage floods of requests</li>
<li>Programs should <a class="glossref" href="../gloss/#throttle" markdown="1">throttle</a> their own activity</li>
<li>Look at a few <a class="glossref" href="../gloss/#summary_statistics" markdown="1">summary statistics</a></li>
</ul>
<p><div class="highlight"><span class="filename">summary-statistics.py</span><pre><span></span><code><span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">datafile</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">packages</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">packages</span><span class="p">[</span><span class="s2">&quot;Releases&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;median&quot;</span><span class="p">,</span> <span class="s2">&quot;var&quot;</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">,</span> <span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">]))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>python version-statistics.py release-count.csv
</code></pre></div>
<div class="highlight"><pre><span></span><code>mean         15.967889
median        4.000000
var        6446.184438
std          80.288134
min           0.000000
max       16187.000000
Name: Releases, dtype: float64
</code></pre></div></p>
<ul>
<li>Half of all packages have had fewer than four releases</li>
<li>The mean is only slightly higher (1/5 of a <a class="glossref" href="../gloss/#stdev" markdown="1">standard deviation</a>)</li>
<li>And yeah, a package with more than 16,000 releases will pull things up<ul>
<li>Cryptocurrency package might be using releases as ledger updates</li>
</ul>
</li>
<li>Use a <a class="glossref" href="../gloss/#histogram" markdown="1">histogram</a> to show the distribution of values<ul>
<li>Its shape (and hence our interpretation) depends on how we <a class="glossref" href="../gloss/#bin" markdown="1">bin</a> the data</li>
</ul>
</li>
</ul>
<p><div class="highlight"><span class="filename">version-histogram.py</span><pre><span></span><code><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>

<span class="n">datafile</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">packages</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Distribution of Releases&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">packages</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Releases&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">packages</span><span class="p">[</span><span class="s2">&quot;Releases&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s1"> missing values&#39;</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">packages</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Releases&#39;</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">log_y</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span><span class="s1">&#39;release-count.svg&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>python version-histogram.py release-count.csv
</code></pre></div>
<div class="highlight"><pre><span></span><code>Distribution of Releases
          Package
Releases         
0.0         11721
1.0         33992
2.0         32829
3.0         14999
4.0         18339
5.0          8946
...
4505.0          1
5133.0          1
6460.0          1
10797.0         1

[561 rows x 1 columns]
14 missing values
</code></pre></div></p>
<figure id="release-count">
  <img src="./release-count.svg" alt="Histogram showing number of releases per package from PyPI."/>
  <figcaption markdown="1">Figure 3.1: Release Count</figcaption>
</figure>

<ul>
<li>Printed output includes the value for packages with zero releases</li>
<li>But does the histogram?<ul>
<li>What does Plotly do with <code>log(0)</code>?</li>
</ul>
</li>
<li>Let's try:</li>
</ul>
<div class="highlight"><span class="filename">version-histogram.py</span><pre><span></span><code><span class="nb">slice</span> <span class="o">=</span> <span class="n">packages</span><span class="p">[</span><span class="n">packages</span><span class="p">[</span><span class="s1">&#39;Releases&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">]</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="nb">slice</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Releases&#39;</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">log_y</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span><span class="s1">&#39;release-count-low.svg&#39;</span><span class="p">)</span>
</code></pre></div>
<figure id="release-count-low">
  <img src="./release-count-low.svg" alt="Histogram showing low end of releases per package from PyPI."/>
  <figcaption markdown="1">Figure 3.2: Release Count (Low End)</figcaption>
</figure>

<ul>
<li>It seems to include zero</li>
<li>But that double-stepping looks weird</li>
<li>Is it a plotting artifact or a result of double-counting packages that are released in multiple formats?<ul>
<li>To answer that question, we'll need to clean up our data...</li>
</ul>
</li>
<li>But first, use a <a class="glossref" href="../gloss/#violin_plot" markdown="1">violin plot</a> to get a better feel for the shape of the data</li>
</ul>
<div class="highlight"><span class="filename">version-other-plots.py</span><pre><span></span><code><span class="n">datafile</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">packages</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>
<span class="nb">slice</span> <span class="o">=</span> <span class="n">packages</span><span class="p">[</span><span class="n">packages</span><span class="p">[</span><span class="s1">&#39;Releases&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">]</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">violin</span><span class="p">(</span><span class="nb">slice</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Releases&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span><span class="s1">&#39;release-count-violin.svg&#39;</span><span class="p">)</span>
</code></pre></div>
<figure id="release-count-violin">
  <img src="./release-count-violin.svg" alt="Violin plot showing almost all packages have just a few releases."/>
  <figcaption markdown="1">Figure 3.3: Violin Plot (Low End)</figcaption>
</figure>

<ul>
<li>Can also use a <a class="glossref" href="../gloss/#box_and_whisker_plot" markdown="1">box-and-whisker plot</a><ul>
<li>Lines show minimum, first <a class="glossref" href="../gloss/#quartile" markdown="1">quartile</a>, median, third quartile, and maximum</li>
<li>Box shows first quartile to third quartile (so half the data lies inside the box)</li>
</ul>
</li>
<li>Distance from first quartile to third quartile is the <a class="glossref" href="../gloss/#iqr" markdown="1">inter-quartile range</a><ul>
<li>Lower and upper lines cut off at 1.5\( \times \)IQR</li>
<li>Anything beyond that is considered an outlier and shown as a point</li>
</ul>
</li>
</ul>
<div class="highlight"><span class="filename">version-other-plots.py</span><pre><span></span><code><span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">box</span><span class="p">(</span><span class="nb">slice</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Releases&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span><span class="s1">&#39;release-count-box.svg&#39;</span><span class="p">)</span>
</code></pre></div>
<figure id="release-count-box">
  <img src="./release-count-box.svg" alt="Box-and-whisker plot showing almost all packages have just a few releases"/>
  <figcaption markdown="1">Figure 3.4: Box-and-Whisker Plot (Low End)</figcaption>
</figure>
      </div>
    </div>
  </body>
</html>
